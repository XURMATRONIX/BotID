#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h>
#include <ArduinoJson.h>
#include <Preferences.h>
#include <HTTPClient.h>
#include "mbedtls/aes.h"

// ==========================================
//        Î›NÃ˜M TECHNOLOGIES - CONFIG
// ==========================================

// --- TARMOQ ---
#define WIFI_SSID "Xurmatillo"
#define WIFI_PASSWORD "Xikmatullayevich2025@"
#define BOT_TOKEN "8550231801:AAHOQZLS1AtAAdQaXmopHTcYlSRve9_qJAM"

// --- FOYDALANUVCHILAR ---
const String USER_1 = "7162045263"; // Î›NÃ˜M (Admin)
const String USER_2 = "7055578231"; // Xurshidaxon

// --- SYSTEM ---
Preferences preferences;
WiFiClientSecure client;
UniversalTelegramBot bot(BOT_TOKEN, client);

// Optimallashtirish: Katta buferlar
const int JSON_BUFFER_SIZE = 4096; 
int botRequestDelay = 500; 
unsigned long lastTimeBotRan;

// --- XAVFSIZLIK ---
String currentKey = "xurmatillo_xurshidaxon_secret_32"; 
const char * iv_str = "vector_init_16bt"; 

// --- SESSISIYA (3 SOAT) ---
bool isSessionActive = false;
unsigned long sessionStartTime = 0;
const unsigned long SESSION_TIMEOUT = 10800000; // 3 soat (ms)

// ==========================================
//        AVTOMATIK XABAR MATNLARI
// ==========================================

const char* MSG_WELCOME_USER2 = 
"ðŸ›¡ *Î›NÃ˜M SECURE NODE â€” TIZIM PASPORTI*\n\n"
"Assalomu alaykum, Xurshidaxon!\n"
"Siz hozirgina oddiy Telegram boti bilan emas, balki Î›NÃ˜M (Xurmatillo) tomonidan ishlab chiqilgan *shaxsiy apparat-shifrlash stansiyasi* bilan aloqa oâ€˜rnatdingiz.\n\n"
"Ushbu tizim sizning xavfsizligingizni dunyodagi eng yuqori standartlar asosida ta'minlaydi.\n\n"
"âš™ï¸ *TIZIM ARSENALI:*\n"
"1. *Miya (Core):* Aloqa bulutda emas, Î›NÃ˜M ning uyidagi jismoniy *ESP32-S3 N16R8* mikrokontrollerida qayta ishlanadi.\n"
"2. *Himoya (Crypto):* Har bir harf AQSh harbiy standarti â€” *AES-256 (CBC Mode)* algoritmi bilan shifrlanadi.\n"
"3. *Kirish:* WebAuthn texnologiyasi orqali Biometrik va Windows Hello himoyasi oâ€˜rnatilgan.\n\n"
"ðŸ“– *FOYDALANISH YOâ€˜RIQNOMASI:*\n\n"
"ðŸ”¹ *1. Matnli Xabarlar:*\n"
"Shunchaki yozing. Bot xabaringizni shifrlaydi va Î›NÃ˜M ga \"oâ€˜qib boâ€˜lmas kod\" shaklida yetkazadi.\n\n"
"ðŸ”¹ *2. Media (Rasm/Video):*\n"
"Ularni bot \"Media Tunneling\" orqali toâ€˜gâ€˜ridan-toâ€˜gâ€˜ri yetkazib beradi.\n\n"
"ðŸ”¹ *3. ðŸ” Kalitni Yangilash:*\n"
"Joriy shifrlash parolini yangilash uchun:\n"
"`Kalitni o'zgartirish: yangi_maxfiy_so'z`\n\n"
"ðŸ”¹ *4. Xavfsizlik Seansi:*\n"
"Tizimga kirish biometrik tasdiqdan soâ€˜ng *3 soat* davomida ochiq turadi.\n\n"
"Xavfsiz aloqa zonasiga xush kelibsiz!\n"
"â€” *AI Assistant & Î›NÃ˜M Technologies*";

// ==========================================
//           SYSTEM FUNCTIONS
// ==========================================

void loadKey() {
  preferences.begin("bot-config", true);
  String savedKey = preferences.getString("aes_key", "");
  preferences.end();
  if (savedKey.length() >= 32) currentKey = savedKey;
}

void saveKey(String newKey) {
  preferences.begin("bot-config", false);
  preferences.putString("aes_key", newKey);
  preferences.end();
  currentKey = newKey;
}

String padString(String input) {
  int len = input.length();
  int padding = 16 - (len % 16);
  for (int i = 0; i < padding; i++) input += (char)padding;
  return input;
}

// AES-256 ENCRYPTION (Optimized)
void encryptMessage(String plainText, unsigned char * outputBuffer) {
  mbedtls_aes_context aes;
  plainText = padString(plainText);
  int len = plainText.length();
  
  char keyChar[32]; memset(keyChar, 0, 32); 
  currentKey.toCharArray(keyChar, 32);
  
  unsigned char ivChar[16]; 
  memcpy(ivChar, iv_str, 16);

  mbedtls_aes_init(&aes);
  mbedtls_aes_setkey_enc(&aes, (unsigned char*)keyChar, 256);
  mbedtls_aes_crypt_cbc(&aes, MBEDTLS_AES_ENCRYPT, len, ivChar, (unsigned char*)plainText.c_str(), outputBuffer);
  mbedtls_aes_free(&aes);
}

// AES-256 DECRYPTION (Optimized)
String decryptMessage(unsigned char * cipherText, int len) {
  mbedtls_aes_context aes;
  char keyChar[32]; memset(keyChar, 0, 32); 
  currentKey.toCharArray(keyChar, 32);
  
  unsigned char ivChar[16]; 
  memcpy(ivChar, iv_str, 16);
  
  unsigned char outputBuffer[len];

  mbedtls_aes_init(&aes);
  mbedtls_aes_setkey_dec(&aes, (unsigned char*)keyChar, 256);
  mbedtls_aes_crypt_cbc(&aes, MBEDTLS_AES_DECRYPT, len, ivChar, cipherText, outputBuffer);
  mbedtls_aes_free(&aes);

  String output = "";
  for(int i=0; i<len; i++) output += (char)outputBuffer[i];
  
  int padVal = (int)output[len - 1];
  if(padVal > 0 && padVal <= 16) {
    output = output.substring(0, len - padVal);
  }
  return output;
}

// DIRECT MEDIA FORWARDING
void customForwardMessage(String target_chat_id, String from_chat_id, String message_id) {
  HTTPClient http;
  String url = "https://api.telegram.org/bot" + String(BOT_TOKEN) + "/forwardMessage";
  String payload = "{\"chat_id\":\"" + target_chat_id + "\",\"from_chat_id\":\"" + from_chat_id + "\",\"message_id\":" + message_id + "}";
  
  http.begin(url);
  http.addHeader("Content-Type", "application/json");
  http.POST(payload);
  http.end();
}

// WEB APP DATA PARSER (Manual Check)
void checkManualUpdates() {
  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  String url = "https://api.telegram.org/bot" + String(BOT_TOKEN) + "/getUpdates?offset=" + String(bot.last_message_received + 1);
  
  http.begin(url);
  int httpCode = http.GET();

  if (httpCode == 200) {
    String payload = http.getString();
    DynamicJsonDocument doc(JSON_BUFFER_SIZE);
    DeserializationError error = deserializeJson(doc, payload);

    if (!error) {
      JsonArray result = doc["result"];
      for (JsonObject update : result) {
        long update_id = update["update_id"];
        if (update_id > bot.last_message_received) {
          bot.last_message_received = update_id;
          
          if (update.containsKey("message") && update["message"].containsKey("web_app_data")) {
            String data = update["message"]["web_app_data"]["data"].as<String>();
            String chat_id = update["message"]["chat"]["id"].as<String>();
            
            if (data == "BIOMETRIC_SUCCESS_KEY_9988") {
               isSessionActive = true;
               sessionStartTime = millis();
               bot.sendMessage(chat_id, "âœ… TASDIQLANDI! SEANS: 3 SOAT.", "");
               return; 
            }
          }
        }
      }
    }
  }
  http.end();
}

// ==========================================
//           CORE LOGIC LOOP
// ==========================================

void handleNewMessages(int numNewMessages) {
  for (int i = 0; i < numNewMessages; i++) {
    String chat_id = bot.messages[i].chat_id;
    String text = bot.messages[i].text;
    String message_id = String(bot.messages[i].message_id);
    
    // --- 1. ACCESS CONTROL ---
    bool isAuthorized = (chat_id == USER_1 || chat_id == USER_2);
    if (!isAuthorized) continue; // Silent Mode for strangers

    String target_chat_id = (chat_id == USER_1) ? USER_2 : USER_1;
    String sender_tag = (chat_id == USER_1) ? "Î›NÃ˜M" : "Xurshidaxon";

    // --- 2. BIOMETRIC CHECK ---
    if (text == "BIOMETRIC_SUCCESS_KEY_9988") {
       isSessionActive = true;
       sessionStartTime = millis();
       bot.sendMessage(chat_id, "âœ… TASDIQLANDI! SEANS: 3 SOAT.", "");
       continue;
    }

    // --- 3. SESSION LOCK ---
    // Agar start yoki kalit almashtirish bo'lmasa, sessiyani tekshiramiz
    if (!isSessionActive && text != "/start" && !text.startsWith("kalitni o'zgartirish")) {
       bot.sendMessage(chat_id, "â›” Tizim qulflangan! Pastdagi tugma orqali tasdiqlang.", "");
       continue;
    }

    if (isSessionActive && (millis() - sessionStartTime > SESSION_TIMEOUT)) {
       isSessionActive = false;
       bot.sendMessage(chat_id, "âŒ› Seans tugadi. Qayta tasdiqlang.", "");
       continue;
    }

    // --- 4. KEY EXCHANGE ---
    String textLower = text; textLower.toLowerCase();
    if (textLower.startsWith("kalitni o'zgartirish:")) {
      String newKeyInput = text.substring(21); newKeyInput.trim(); 
      if (newKeyInput.length() < 8) {
        bot.sendMessage(chat_id, "âŒ Kalit juda qisqa!", "");
      } else {
        while (newKeyInput.length() < 32) newKeyInput += "#";
        if (newKeyInput.length() > 32) newKeyInput = newKeyInput.substring(0, 32);
        saveKey(newKeyInput); 
        bot.sendMessage(chat_id, "âœ… Yangi kalit o'rnatildi!", "");
        bot.sendMessage(target_chat_id, "âš ï¸ DIQQAT: " + sender_tag + " kalitni yangiladi.", "");
      }
      continue;
    }

    // --- 5. START & INFO ---
    if (text == "/start") {
      if (chat_id == USER_2) {
        // XURSHIDAXON UCHUN MAXSUS TUSHUNTIRISH
        bot.sendMessage(chat_id, MSG_WELCOME_USER2, "Markdown");
      } else {
        // Î›NÃ˜M UCHUN QISQA STATUS
        bot.sendMessage(chat_id, "ðŸ”’ Î›NÃ˜M SECURE NODE.\nSystem Online.", "");
      }
      continue;
    }

    // --- 6. SECURE TRANSMISSION ---
    if (text != "") { 
      // TEXT -> ENCRYPT -> SEND
      int len = padString(text).length();
      unsigned char cipherText[len];
      encryptMessage(text, cipherText);
      String decryptedText = decryptMessage(cipherText, len);
      
      String msgToSend = "ðŸ“© " + sender_tag + ":\n" + decryptedText;
      bot.sendMessage(target_chat_id, msgToSend, "");
    } else { 
      // MEDIA -> FORWARD
      customForwardMessage(target_chat_id, chat_id, message_id);
    }
  }
}

void setup() {
  Serial.begin(115200);
  loadKey();

  // Wi-Fi Connection
  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  WiFi.setAutoReconnect(true); // Stabil aloqa uchun
  
  client.setCACert(TELEGRAM_CERTIFICATE_ROOT); // Xavfsiz ulanish

  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nSystem Online.");
}

void loop() {
  // Wi-Fi uzilib qolsa, qayta ulanishni kutish
  if (WiFi.status() == WL_CONNECTED) {
    if (millis() > lastTimeBotRan + botRequestDelay) {
      checkManualUpdates(); // 1. Mini App signallarini tekshirish
      
      int numNewMessages = bot.getUpdates(bot.last_message_received + 1);
      while (numNewMessages) {
        handleNewMessages(numNewMessages); // 2. Oddiy xabarlarni qayta ishlash
        numNewMessages = bot.getUpdates(bot.last_message_received + 1);
      }
      lastTimeBotRan = millis();
    }
  }
}
