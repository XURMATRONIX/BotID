<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Biometric Auth</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #1c1c1d);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
       .container { text-align: center; padding: 20px; }
       .icon { font-size: 80px; margin-bottom: 20px; }
       .btn {
            background-color: var(--tg-theme-button-color, #2ea6ff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }
        #status { margin-top: 15px; font-size: 14px; opacity: 0.8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">üîí</div>
        <h2>Xavfsiz Kirish</h2>
        <p>Xabarni o'qish uchun shaxsingizni tasdiqlang</p>
        
        <button id="authBtn" class="btn" onclick="startAuth()">Tasdiqlash</button>
        <div id="status">Tizim tayyorlanmoqda...</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        const bm = tg.BiometricManager;
        const statusEl = document.getElementById('status');
        const btn = document.getElementById('authBtn');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –±–∏–æ–º–µ—Ç—Ä–∏–∏
        function initBiometrics() {
            if (!bm.isInited) {
                bm.init(() => {
                    checkAvailability();
                });
            } else {
                checkAvailability();
            }
        }

        function checkAvailability() {
            if (!bm.isBiometricAvailable) {
                statusEl.innerText = "Qurilmada biometriya mavjud emas.";
                statusEl.style.color = "#ff453a";
                btn.style.display = "none";
                return;
            }
            
            if (!bm.isAccessGranted) {
                statusEl.innerText = "Biometrik ruxsat kerak.";
                btn.innerText = "Ruxsat Berish";
                btn.onclick = requestAccess;
            } else {
                statusEl.innerText = "Avtorizatsiya tayyor.";
                btn.innerText = "Barmoq izi / Face ID";
                btn.onclick = authenticate;
            }
        }

        function requestAccess() {
            bm.requestAccess({
                reason: "Shifrlangan xabarlarni ochish uchun"
            }, (granted) => {
                if (granted) {
                    checkAvailability();
                } else {
                    statusEl.innerText = "Ruxsat rad etildi.";
                }
            });
        }

        function authenticate() {
            bm.authenticate({
                reason: "Xabarni deshifrlash"
            }, (success, token) => {
                if (success) {
                    statusEl.innerText = "Muvaffaqiyatli! Yuborilmoqda...";
                    statusEl.style.color = "#30d158";
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞–∫–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ—Ç—É
                    // –í–∞–∂–Ω–æ: –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å—å initData
                    const data = JSON.stringify({
                        action: "BIO_SUCCESS",
                        timestamp: Date.now(),
                        token: token |

| "valid"
                    });
                    
                    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É. –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç —Å–æ–±—ã—Ç–∏–µ "web_app_data" –Ω–∞ ESP32
                    tg.sendData(data); 
                } else {
                    statusEl.innerText = "Xatolik yuz berdi. Qaytadan urinib ko'ring.";
                    statusEl.style.color = "#ff453a";
                }
            });
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (bm) {
            initBiometrics();
        } else {
            statusEl.innerText = "Telegram versiyasi eskirgan.";
        }
    </script>
</body>
</html>
