<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ΛNØM Mini-Auth</title>
  <style>
    body { font-family: system-ui, -apple-system, Roboto, "Segoe UI", Arial; padding: 18px; background:#f7f7fb; color:#111; }
    .card { max-width:720px; margin:24px auto; background:white; padding:20px; border-radius:12px; box-shadow:0 6px 24px rgba(20,20,40,0.06); }
    h1{margin:0 0 8px;font-size:20px}
    p{margin:8px 0 14px; color:#444}
    button{display:inline-block;padding:10px 14px;border-radius:10px;border:0;background:#2563eb;color:white;font-weight:600;}
    .note{font-size:13px;color:#666;margin-top:12px}
    #log{white-space:pre-wrap;margin-top:12px;background:#f0f4ff;padding:8px;border-radius:8px;font-size:13px;color:#123;}
  </style>
</head>
<body>
  <div class="card">
    <h1>ΛNØM — Biometrik tasdiq</h1>
    <p>Bu Mini-App yordamida biometrik (Platform WebAuthn) yoki boshqa brauzer autentifikatori orqali tasdiqlaysiz. Tasdiqlashdan so‘ng Mini-App sizga imzolangan token yuboradi va avtomatik yopiladi.</p>

    <div>
      <button id="btnAuth">Biometrik tasdiqlash</button>
      <button id="btnDemoJWT" style="margin-left:10px;background:#10b981">Demo: yubor token</button>
    </div>

    <div class="note">Eslatma: demo versiya — HMAC siri faqat test uchun client-side'da saqlanadi. Production uchun server-side imzolashni tashkil eting.</div>
    <div id="log"></div>
  </div>

<script>
  // ----- CONFIG (MAQSADLI: SERVER-OR-SAFE HMAC in production) -----
  // Demo HMAC secret (DON'T USE IN PRODUCTION!). Replace or provision securely.
  const DEMO_HMAC_SECRET = "change_this_to_real_secret_on_server";

  // Helper: base64url encode
  function base64UrlEncode(buf) {
    let b64 = btoa(String.fromCharCode.apply(null, new Uint8Array(buf)));
    return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }
  // Helper: UTF-8 to ArrayBuffer
  function str2ab(str) {
    const encoder = new TextEncoder();
    return encoder.encode(str);
  }

  // HMAC-SHA256 using WebCrypto
  async function hmacSign(secret, message) {
    const key = await crypto.subtle.importKey(
      "raw",
      str2ab(secret),
      { name: "HMAC", hash: "SHA-256" },
      false,
      ["sign"]
    );
    const sig = await crypto.subtle.sign("HMAC", key, str2ab(message));
    return new Uint8Array(sig);
  }

  // Create JWT-like token: header.payload.signature (base64url)
  async function createToken(payloadObj) {
    const header = { alg: "HS256", typ: "JWT" };
    const headerB64 = base64UrlEncode(str2ab(JSON.stringify(header)));
    const payloadB64 = base64UrlEncode(str2ab(JSON.stringify(payloadObj)));
    const signing = headerB64 + "." + payloadB64;
    const sigBuf = await hmacSign(DEMO_HMAC_SECRET, signing);
    const sigB64 = base64UrlEncode(sigBuf);
    return signing + "." + sigB64;
  }

  // WebAuthn / platform authenticator trigger (best-effort)
  async function webAuthnFlow() {
    // NOTE: In production you must provide a real challenge from server.
    // Here we use a random challenge for demonstration (may fail on some browsers).
    const challenge = new Uint8Array(32);
    window.crypto.getRandomValues(challenge);

    // PublicKeyCredentialRequestOptions - requireUserVerification: "required" for biometrics
    const publicKey = {
      challenge: challenge,
      timeout: 60000,
      userVerification: "preferred", // "required" may force biometric
      allowCredentials: [] // empty for demo (platform authenticator should accept)
    };

    try {
      const assertion = await navigator.credentials.get({ publicKey });
      // success; create token
      const uid = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) ? Telegram.WebApp.initDataUnsafe.user.id : 0;
      const exp = Math.floor(Date.now()/1000) + (3 * 60 * 60); // +3 hours
      const payload = { isAuthenticated: true, exp: exp, user_id: uid, method: "webauthn" };
      const token = await createToken(payload);
      log("Biometric successful. Token created.");
      sendTokenToBot(token);
    } catch(e) {
      log("WebAuthn failed or not supported: " + e);
      // fallback: create demo token anyway (useful for testing)
      const uid = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) ? Telegram.WebApp.initDataUnsafe.user.id : 0;
      const exp = Math.floor(Date.now()/1000) + (3 * 60 * 60);
      const payload = { isAuthenticated: true, exp: exp, user_id: uid, method: "fallback" };
      const token = await createToken(payload);
      log("Fallback token created.");
      sendTokenToBot(token);
    }
  }

  function log(msg) {
    const el = document.getElementById('log');
    el.textContent += msg + "\n";
  }

  // Send token to Telegram bot via WebApp.sendData (bot receives as message)
  function sendTokenToBot(token) {
    try {
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.sendData(token);
        // auto close modal after a short delay to allow sendData to deliver
        setTimeout(()=> {
          try { Telegram.WebApp.close(); } catch(e){}
        }, 700);
        log("Token yuborildi va modal yopilmoqda...");
      } else {
        // Not in Telegram WebApp; show token for manual copy
        log("Mini-App not in Telegram. Token:\n" + token);
      }
    } catch (e) {
      log("sendData error: " + e);
    }
  }

  // DEMO button to create token without WebAuthn (for environment that lacks it)
  document.getElementById('btnDemoJWT').addEventListener('click', async () => {
    const uid = (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) ? Telegram.WebApp.initDataUnsafe.user.id : 0;
    const exp = Math.floor(Date.now()/1000) + (3 * 60 * 60);
    const payload = { isAuthenticated: true, exp: exp, user_id: uid, method: "demo" };
    const token = await createToken(payload);
    log("Demo token tayyorlandi, yuborilmoqda...");
    sendTokenToBot(token);
  });

  document.getElementById('btnAuth').addEventListener('click', async () => {
    log("Biometrik auth boshlanmoqda...");
    await webAuthnFlow();
  });

  // If embedded inside Telegram WebApp, expand and show theme
  window.addEventListener('load', function() {
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      try { Telegram.WebApp.expand(); } catch(e){}
    }
  });
</script>
</body>
</html>
